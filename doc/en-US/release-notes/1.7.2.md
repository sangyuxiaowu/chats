<!-- Language: en-US -->
<p align="right"><b>English</b> | <a href="../../zh-CN/release-notes/1.7.2.md">简体中文</a></p>

# Chats 1.7.2 Release Notes

> Release Date: October 24, 2025 (25 commits since 1.7.1)

Version 1.7.2 is a significant feature enhancement and quality improvement release, primarily focused on streaming image generation support, code execution capabilities, API testing framework, extended model support, along with multiple frontend experience optimizations and bug fixes.

## Highlights

- Streaming Image Generation: `gpt-image-1` and `gpt-image-1-mini` now support streaming image generation with real-time progress
- Gemini Code Execution Display Optimization: Code execution results displayed as tool calls for better clarity
- API Integration Testing Framework: New `Chats.BE.ApiTest` project with comprehensive OpenAI-compatible API tests
- New Model Support: Added `gpt-5-codex`, `gpt-5-pro`, and `gpt-image-1-mini` model references
- Code Execution Configuration: ChatConfig now includes `CodeExecutionEnabled` field
- Reasoning Level Expansion: Added `minimal` reasoning level for gpt-5 series
- Frontend Experience Optimization: Image size adjustments, Markdown line break fixes, UI layout improvements
- Dependency Upgrades: Updated 11 third-party dependencies to keep the tech stack current

---

## Feature Details and Improvements

### 1) Streaming Image Generation Support (Database Migration Required)

Complete streaming support added for image generation service:
- **Backend Implementation**:
  - Major refactor of `ImageGenerationService` with streaming support for `gpt-image-1` and `gpt-image-1-mini`
  - Real-time image generation progress push, allowing users to view the generation process instantly
  - Optimized network transmission: Removed unnecessary server responses (type 12) to save bandwidth
  - Automatic routing: Switches to non-streaming mode when `n>1` (streaming mode doesn't support multiple image generation)
  
- **Frontend Support**:
  - Full frontend support for streaming image generation
  - Real-time display of image generation progress
  - Image size adjustment support for `gpt-image-1-mini` model
  - Tested and confirmed streaming image generation works correctly

- **Bug Fixes**:
  - Fixed reasoning effort not supported in API image generation service
  - Fixed reasoning effort settings not taking effect

### 2) Gemini Code Execution Display Optimization

Optimized display of Google AI (Gemini) code execution results:
- Code execution results displayed as tool calls instead of raw text output
- New `ToolCallSegment` type to support code execution tool calls
- Extended `StepContent` to support serialization and deserialization of tool call segments
- Added `FromCodeExecution` factory method to `ChatSegmentItem`
- Frontend can now display code execution process and results more clearly, enhancing user experience

### 3) API Integration Testing Framework

New `Chats.BE.ApiTest` xUnit test project for comprehensive OpenAI-compatible API testing:
- **Test Coverage**:
  - `ChatCompletionTests`: Chat completion API tests
  - `ImageGenerationTests`: Image generation API tests (252 lines)
  - `ToolCallTests`: Tool call API tests
  - `ReasoningModelTests`: Reasoning model API tests
  - `ModelsTests`: Model list API tests
  - `CachedCompletionTests`: Cached completion API tests

- **Testing Infrastructure**:
  - `ApiTestFixture`: Test fixture providing test environment setup
  - `Program.cs`: 348 lines, complete test program entry point
  - `appsettings.json`: Test configuration file
  - `QUICKSTART.md`: Quick start documentation

- **Statistics**: Added 1,252 lines of test code ensuring API compatibility and quality

### 4) Code Execution Configuration (Database Migration Required)

Added code execution control to ChatConfig:
- New `CodeExecutionEnabled` field to control whether code execution is enabled
- Database migration script: `20251016-1.7.2.sql`
- Default value is `false` (disabled), administrators can enable as needed
- Supports fine-grained code execution permission control

### 5) Reasoning Level Expansion (Database Migration Required)

Extended Reasoning Effort configuration:
- Added `minimal` reasoning level for gpt-5 series models
- Reasoning level adjustment:
  - Original levels: 1 (low), 2 (medium), 3 (high)
  - New levels: 1 (minimal), 2 (low), 3 (medium), 4 (high)
- Automatic database migration: Adds 1 to existing non-zero values to adapt to the new level system
- Migration only executes if level 4 doesn't exist in the database to avoid duplicate execution

### 6) New Model Support (Database Migration Required)

Added the following models to the `ModelReference` table:

**gpt-5-codex** (Model IDs 133/533):
- Release Date: September 15, 2025
- Context Window: 400,000 tokens
- Max Response: 128,000 tokens
- Pricing: Input $2/1M tokens, Output $10/1M tokens
- Supports streaming, vision, and system prompts

**gpt-5-pro** (Model IDs 134/534):
- Release Date: August 7, 2025
- Context Window: 400,000 tokens
- Max Response: 272,000 tokens
- Pricing: Input $15/1M tokens, Output $120/1M tokens
- Supports streaming, vision, system prompts, and reasoning responses

**gpt-image-1-mini** (Model IDs 135/535):
- Release Date: October 6, 2025
- Context Window: 65,536 tokens
- Max Response: 10 tokens
- Pricing: Input $2/1M tokens, Output $8/1M tokens
- Supports streaming image generation

### 7) Frontend Experience Optimization

Multiple frontend user experience improvements:

**Markdown Rendering Optimization**:
- Fixed extra blank lines in Markdown response messages
- Enabled `remark-breaks` plugin to properly handle soft line breaks
- Message display now conforms better to Markdown standards

**UI Layout Improvements**:
- Fixed SystemPrompt textarea scrolling issue
- Fixed excessive spacing below chat messages after reducing input rows
- Shortened chat input header height to save screen space
- Tools list now displayed in fullscreen mode

**Code Refactoring**:
- Extracted `chatApi.ts` from `Chat.tsx` (1431→1384 lines)
- Improved code maintainability and modularity

### 8) Dependency Upgrades

Updated 11 third-party dependencies to the latest stable versions:

**AWS & Azure**:
- `AWSSDK.S3`: 4.0.7.1 → 4.0.7.11
- `Azure.Storage.Blobs`: 12.25.0 → 12.26.0

**Entity Framework Core**:
- `Microsoft.EntityFrameworkCore.Design`: 9.0.9 → 9.0.10
- `Microsoft.EntityFrameworkCore.Sqlite`: 9.0.9 → 9.0.10
- `Microsoft.EntityFrameworkCore.SqlServer`: 9.0.9 → 9.0.10

**Other Key Dependencies**:
- `MiniExcel`: 1.41.3 → 1.41.4
- `Mscc.GenerativeAI`: 2.8.9 → 2.8.17 (Google AI SDK)
- `OpenAI`: 2.4.0 → 2.5.0 (OpenAI SDK)
- `Swashbuckle.AspNetCore`: 9.0.4 → 9.0.6 (Swagger)
- `System.Runtime.Caching`: 9.0.9 → 9.0.10
- `TencentCloudSDK.Sms`: 3.0.1273 → 3.0.1330 (Tencent Cloud SMS)

### 9) Other Improvements

**Development Documentation**:
- New documentation: How to add a field to ChatConfig (`add-chatconfig-field.md`)
- Helps developers quickly understand the ChatConfig extension process

**Bug Fixes**:
- Fixed BE compilation error caused by MCP upgrade
- Fixed frontend build error

---

## Database Migration

**Important Notice**: This version includes database schema changes. Please execute the migration script before upgrading.

Migration script location: `src/scripts/db-migration/1.7/20251016-1.7.2.sql`

Major changes:
1. Added `ChatConfig.CodeExecutionEnabled` field
2. Adjusted `ChatConfig.ReasoningEffort` values (added 1 to existing values)
3. Added/updated 8 model records in `ModelReference` table

The migration script includes safety checks and can be executed repeatedly.

---

## Upgrade Recommendations

1. **Backup Database**: Always backup your database before upgrading
2. **Execute Migration Script**: Run `20251016-1.7.2.sql`
3. **Update Backend**: Deploy the new backend code
4. **Update Frontend**: Deploy the new frontend code
5. **Verify Features**:
   - Test streaming image generation functionality
   - Verify new models are displayed correctly
   - Check reasoning level settings work properly
   - Confirm code execution functionality configuration is correct

---

## Tech Stack Versions

- .NET: 8.0/9.0
- Entity Framework Core: 9.0.10
- OpenAI SDK: 2.5.0
- Google AI SDK: 2.8.17
- Azure Storage Blobs: 12.26.0
- AWS S3 SDK: 4.0.7.11

---

## Contributors

Thanks to all the developers who contributed to this release!

---

## What's Next

- Continue optimizing image generation experience
- Expand support for more models
- Enhance API test coverage
- Performance optimization and stability improvements

For questions or suggestions, please provide feedback on [GitHub Issues](https://github.com/sdcb/chats/issues).
