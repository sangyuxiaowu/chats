<!-- Language: zh-CN -->
<p align="right"><a href="../../en-US/release-notes/1.7.2.md">English</a> | <b>简体中文</b></p>

# Chats 1.7.2 发布说明

> 发布日期：2025-10-24（相对 1.7.1 以来 25 次提交）

1.7.2 是一次重要的功能增强与质量改进版本，主要聚焦于图像生成流式支持、代码执行功能、API 测试框架、模型支持扩展，以及多项前端体验优化和问题修复。

## 亮点概览

- 图像生成流式支持：`gpt-image-1` 和 `gpt-image-1-mini` 支持流式图像生成，实时查看生成进度
- Gemini 代码执行展示优化：代码执行结果以工具调用形式展示，更加清晰直观
- API 集成测试框架：新增 `Chats.BE.ApiTest` 项目，全面测试 OpenAI 兼容 API
- 新模型支持：添加 `gpt-5-codex`、`gpt-5-pro`、`gpt-image-1-mini` 模型引用
- 代码执行功能配置：ChatConfig 新增 `CodeExecutionEnabled` 字段
- 推理级别扩展：为 gpt-5 系列添加 `minimal` 推理级别
- 前端体验优化：图像尺寸调整、Markdown 换行修复、UI 布局改进
- 依赖升级：升级 11 个第三方依赖包，保持技术栈最新

---

## 新功能与改进详情

### 1) 图像生成流式支持（需要数据库迁移）

为图像生成服务添加完整的流式支持：
- **后端实现**：
  - `ImageGenerationService` 大幅重构，支持 `gpt-image-1` 和 `gpt-image-1-mini` 流式生成
  - 实时推送图像生成进度，用户可即时查看生成过程
  - 优化网络传输：移除不必要的服务器响应（类型 12），节省流量
  - 自动路由：当 `n>1` 时自动切换到非流式模式（流式模式不支持多图生成）
  
- **前端支持**：
  - 前端完整支持图像流式生成功能
  - 实时显示图像生成进度
  - 支持 `gpt-image-1-mini` 模型的图像尺寸调整
  - 已测试确认流式图像生成功能正常工作

- **问题修复**：
  - 修复推理级别（reasoning effort）在 API 图像生成服务中不支持的问题
  - 修复推理级别设置不生效的问题

### 2) Gemini 代码执行展示优化

优化 Google AI (Gemini) 的代码执行结果展示：
- 代码执行结果以工具调用（Tool Call）形式展示，而非原始文本输出
- 新增 `ToolCallSegment` 类型支持代码执行工具调用
- `StepContent` 扩展支持工具调用段落的序列化和反序列化
- `ChatSegmentItem` 新增 `FromCodeExecution` 工厂方法
- 前端可更清晰地展示代码执行的过程和结果，提升用户体验

### 3) API 集成测试框架

新增 `Chats.BE.ApiTest` xUnit 测试项目，全面测试 OpenAI 兼容 API：
- **测试覆盖**：
  - `ChatCompletionTests`：聊天对话完成 API 测试
  - `ImageGenerationTests`：图像生成 API 测试（252 行）
  - `ToolCallTests`：工具调用 API 测试
  - `ReasoningModelTests`：推理模型 API 测试
  - `ModelsTests`：模型列表 API 测试
  - `CachedCompletionTests`：缓存对话完成 API 测试

- **测试基础设施**：
  - `ApiTestFixture`：测试装置，提供测试环境设置
  - `Program.cs`：348 行，完整的测试程序入口
  - `appsettings.json`：测试配置文件
  - `QUICKSTART.md`：快速开始文档

- **统计**：新增 1252 行测试代码，确保 API 兼容性和质量

### 4) 代码执行功能配置（需要数据库迁移）

为 ChatConfig 添加代码执行控制：
- 新增 `CodeExecutionEnabled` 字段，控制是否启用代码执行功能
- 数据库迁移脚本：`20251016-1.7.2.sql`
- 默认值为 `false`（禁用），管理员可按需启用
- 支持细粒度的代码执行权限控制

### 5) 推理级别扩展（需要数据库迁移）

扩展推理级别（Reasoning Effort）配置：
- 为 gpt-5 系列模型添加 `minimal` 推理级别
- 推理级别调整：
  - 原有级别：1（低）、2（中）、3（高）
  - 新增级别：1（minimal）、2（低）、3（中）、4（高）
- 数据库自动迁移：将现有非零值加 1，以适配新的级别体系
- 仅在数据库中不存在级别 4 时执行迁移，避免重复执行

### 6) 新模型支持（需要数据库迁移）

在 `ModelReference` 表中新增以下模型：

**gpt-5-codex**（模型 ID 133/533）：
- 发布日期：2025-09-15
- 上下文窗口：400,000 tokens
- 最大响应：128,000 tokens
- 定价：输入 $2/1M tokens，输出 $10/1M tokens
- 支持流式、视觉、系统提示

**gpt-5-pro**（模型 ID 134/534）：
- 发布日期：2025-08-07
- 上下文窗口：400,000 tokens
- 最大响应：272,000 tokens
- 定价：输入 $15/1M tokens，输出 $120/1M tokens
- 支持流式、视觉、系统提示、推理响应

**gpt-image-1-mini**（模型 ID 135/535）：
- 发布日期：2025-10-06
- 上下文窗口：65,536 tokens
- 最大响应：10 tokens
- 定价：输入 $2/1M tokens，输出 $8/1M tokens
- 支持流式图像生成

### 7) 前端体验优化

多项前端用户体验改进：

**Markdown 渲染优化**：
- 修复 Markdown 响应消息中的额外空行问题
- 启用 `remark-breaks` 插件，正确处理软换行
- 消息展示更符合 Markdown 规范

**UI 布局改进**：
- 修复 SystemPrompt 文本框滚动问题
- 修复减少输入行数后聊天消息下方过多空白的问题
- 聊天输入框头部高度缩短，节省屏幕空间
- 全屏模式下也显示工具列表

**代码重构**：
- 将 `chatApi.ts` 从 `Chat.tsx` 中独立出来（1431→1384 行）
- 提升代码可维护性和模块化

### 8) 依赖升级

升级 11 个第三方依赖包到最新稳定版本：

**AWS & Azure**：
- `AWSSDK.S3`：4.0.7.1 → 4.0.7.11
- `Azure.Storage.Blobs`：12.25.0 → 12.26.0

**Entity Framework Core**：
- `Microsoft.EntityFrameworkCore.Design`：9.0.9 → 9.0.10
- `Microsoft.EntityFrameworkCore.Sqlite`：9.0.9 → 9.0.10
- `Microsoft.EntityFrameworkCore.SqlServer`：9.0.9 → 9.0.10

**其他关键依赖**：
- `MiniExcel`：1.41.3 → 1.41.4
- `Mscc.GenerativeAI`：2.8.9 → 2.8.17（Google AI SDK）
- `OpenAI`：2.4.0 → 2.5.0（OpenAI SDK）
- `Swashbuckle.AspNetCore`：9.0.4 → 9.0.6（Swagger）
- `System.Runtime.Caching`：9.0.9 → 9.0.10
- `TencentCloudSDK.Sms`：3.0.1273 → 3.0.1330（腾讯云短信）

### 9) 其他改进

**开发文档**：
- 新增文档：如何向 ChatConfig 添加字段（`add-chatconfig-field.md`）
- 帮助开发者快速理解 ChatConfig 扩展流程

**问题修复**：
- 修复 MCP 升级导致的 BE 编译错误
- 修复前端构建错误

---

## 数据库迁移

**重要提示**：本版本包含数据库架构变更，升级前请执行迁移脚本。

迁移脚本位置：`src/scripts/db-migration/1.7/20251016-1.7.2.sql`

主要变更：
1. 新增 `ChatConfig.CodeExecutionEnabled` 字段
2. 调整 `ChatConfig.ReasoningEffort` 值（现有值加 1）
3. 新增/更新 `ModelReference` 表中的 8 个模型记录

迁移脚本已包含安全检查，可重复执行。

---

## 升级建议

1. **备份数据库**：升级前务必备份数据库
2. **执行迁移脚本**：运行 `20251016-1.7.2.sql`
3. **更新后端**：部署新版本后端代码
4. **更新前端**：部署新版本前端代码
5. **验证功能**：
   - 测试图像生成流式功能
   - 验证新模型是否正常显示
   - 检查推理级别设置是否正常
   - 确认代码执行功能配置正常

---

## 技术栈版本

- .NET：8.0/9.0
- Entity Framework Core：9.0.10
- OpenAI SDK：2.5.0
- Google AI SDK：2.8.17
- Azure Storage Blobs：12.26.0
- AWS S3 SDK：4.0.7.11

---

## 贡献者

感谢所有为本版本做出贡献的开发者！

---

## 下一步计划

- 继续优化图像生成体验
- 扩展更多模型支持
- 增强 API 测试覆盖率
- 性能优化与稳定性提升

如有问题或建议，欢迎在 [GitHub Issues](https://github.com/sdcb/chats/issues) 反馈。
