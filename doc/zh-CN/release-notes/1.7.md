<!-- Language: zh-CN -->
<p align="right"><a href="../../en-US/release-notes/1.7.md">English</a> | <b>简体中文</b></p>

# Chats 1.7.0 发布说明（重大更新）

> 发布日期：2025-09-20（相对 1.6.9.30 以来 100+ 次提交）

1.7.0 是一次非常大的版本升级，核心围绕 MCP（Model Context Protocol）全面落地与工具调用体验打造，并伴随数据库与数据模型的大规模重构、模型/密钥/预设的拖拽排序、新的 Markdown Mermaid 渲染、图片尺寸控制及大量前后端体验改进与问题修复。

## 亮点概览

- 全面支持 MCP：服务端/前端联动、用户级授权、工具抓取、会话调用与权限校验
- 工具调用（Tool Call）强化：SSE 事件更丰富、消息内容新增工具请求/响应类型、前端流式展示
- 数据模型与数据库重构（破坏性变更）：Message→ChatTurn/Step 分层、历史数据迁移脚本、默认值约束清理
- 模型与密钥管理重构：Provider/Key/Model 支持手风琴分组与拖拽排序，后台 API 与表结构配套
- 聊天体验升级：单条/整段重新生成、系统提示编辑/渲染模式、自动隐藏输入、更丰富的状态提示
- Markdown Mermaid 新增：更优暗/亮主题适配、全屏查看、缓存与去抖动、流式友好
- 图片生成尺寸：新增常用尺寸并可在会话中指定
- OpenAI 兼容面更强：工具调用适配修复（含 gpt-5/Qwen 等）、Keycloak 登录兼容提升、Google AI 联调通过

---

## 新功能与改进详情

### 1) MCP（Model Context Protocol）支持

后端新增实体与关系：
- 表：`McpServer`、`McpTool`、`UserMcp`、`ChatConfigMcp`
- `UserMcp` 精准控制用户对 MCP Server 的访问，创建者自动被分配
- Server 标签全局唯一，禁止包含冒号 `:`；Headers 必须为空或合法 JSON 对象

后端 API（节选）：
- 列表/管理/详情：`GET /api/mcp`、`GET /api/mcp/management`、`GET /api/mcp/{id}`
- 创建/更新/删除：`POST /api/mcp`、`PUT /api/mcp/{id}`、`DELETE /api/mcp/{id}`
- 抓取工具：`POST /api/mcp/fetch-tools`（SSE 连接远端 MCP Server 枚举工具）
- 用户分配：`POST /api/mcp/{id}/assign-to-users`、查询未分配与已分配用户等

聊天联动：
- 每个 Chat Span 可绑定多个 MCP（`ChatConfigMcp`）
- 服务端会在会话前校验当前用户是否具备对应 MCP Server 的访问权限（基于 `UserMcp`）
- 工具调用流式输出，参数与结果写入消息内容，前端可视化展示

前端管理：
- 设置页新增「MCP」标签页，可新增/编辑 MCP Server、抓取工具、分配用户、按权限显示可编辑状态

### 2) 工具调用与流式协议

- SSE 事件种类扩展（`SseResponseKind`）：`CallingTool`、`ToolProgress`、`ToolCompleted`、`StartResponse`、`StartReasoning`、`ImageGenerated` 等
- 消息内容新增类型：`toolCall`、`toolResponse`（前端将工具参数流式拼装并显示调用结果）
- 服务端 SSE 输出结构采用更丰富的 Json 多态格式，前端类型已同步更新

### 3) 数据库与数据模型重构（破坏性变更）

为提升可维护性与可观测性，本次对消息存储层进行重构。

- 表与模型调整：
  - `Message` → `ChatTurn`
  - `MessageContent*` → `Step*`（新增 `Step` 表，`StepContent` 关联 `Step`）
  - `Chat.LeafMessageId` → `LeafTurnId`
- 用量关联变更：
  - `UserModelUsage` 不再引用 `UserModel`，改为 `UserId` + `ModelId`
  - `UsageTransaction` 不再引用 `UserModel`，改为直接 `ModelId`
  - 删除 `UserModel.IsDeleted`
- 归档与性能：
  - 新增 `ChatConfigArchived` 存档表，迁移原 `HashCode` 并自 `ChatConfig` 移除
- 排序能力铺垫：
  - `ModelKey` 增加 `Order`，`Model.Order` 改为非空
  - `ChatPreset` 增加 `Order`
- 默认值约束清理：删除多处默认值约束以避免“隐式写入”，统一由应用层显式控制
- 迁移脚本（SQL Server）：`src/scripts/db-migration/1.7/20250516-mcp.sql`

> 注意：此部分为破坏性变更，升级前务必备份数据库并严格按升级指南执行。

### 4) 模型与密钥管理

- 全新模型管理页面：Provider/Key 的手风琴式展开
- 基于 dnd-kit 的拖拽排序：支持 Provider、Model、ModelKey 的顺序调整
- 后端提供对应的重排序 API 与字段，支持精细化排序持久化
- 支持用户级模型管理、用量统计跳转、Provider 图标展示

### 5) 聊天体验与易用性

- 重新生成：
  - 单条重新生成：`POST /api/chats/regenerate-assistant-message`
  - 从某条用户消息开始重新生成该段后的所有助手消息：`POST /api/chats/regenerate-all-assistant-message`
- 系统提示：新增「编辑/渲染」双模式
- 图片尺寸：支持 1024×1024、1536×1024、1024×1536（`KnownImageSize` 与 `ChatConfig.ImageSizeId`）
- Mermaid Markdown：
  - 新增 `MermaidBlock` 与全屏查看组件，暗/亮主题适配
  - 流式渲染去抖、SVG 缓存与异常回退，减少闪烁与失败
- 其他优化：
  - 输入框在模型生成时自动隐藏，提升沉浸体验
  - 侧边栏多图标、按钮提示、禁用态提示、移动端页面与多处 UI 微调

### 6) OpenAI 兼容与第三方

- OpenAI Compatible 通道继续完善
- 修复 gpt-5/Qwen 等模型在工具调用场景的兼容问题
- Keycloak 登录兼容性优化
- Google AI 通道联调通过

### 7) 管理策略与权限

- MCP Server 标签唯一且禁用 `:`，Headers 必须为空或 JSON 对象
- 默认不自动加载 MCP 服务，访问完全以 `UserMcp` 控制

### 8) 问题修复与杂项

- 多处前端构建/运行错误修复，依赖升级与清理 `console.log`
- 共享页显示、初始配置加载/保存、模型引用加载、空轮次与边界情况修复
- 提示词/标题的若干修复与文案微调
- 脚本：新增/合并恢复脚本（如 `restore-dev.local`），`dev.win.sql` 更新

---

## 升级指南（务必阅读）

1. 备份数据库（强烈建议）
2. 在 SQL Server 上执行迁移脚本：`src/scripts/db-migration/1.7/20250516-mcp.sql`
3. 后端重新构建与部署；前端依赖变化较多，建议删除 `src/FE/node_modules` 后重新安装依赖并构建
4. 以管理员身份登录，前往「设置 → MCP」新增或导入 MCP Server，并按需分配给用户
5. 如需使用排序能力，前往模型管理界面进行 Provider/Model/Key/预设 的拖拽排序

> 如您有直接依赖数据库结构或默认值的外部脚本/报表，请据此版本的结构调整相应逻辑。

---

## API 变化（节选）

- 新增聊天再生成：
  - `POST /api/chats/regenerate-assistant-message`
  - `POST /api/chats/regenerate-all-assistant-message`
- 新增 MCP 管理/分配：
  - `GET /api/mcp`、`GET /api/mcp/management`、`GET /api/mcp/{id}`
  - `POST /api/mcp`、`PUT /api/mcp/{id}`、`DELETE /api/mcp/{id}`
  - `POST /api/mcp/fetch-tools`
  - `POST /api/mcp/{id}/assign-to-users`、`GET /api/mcp/{id}/get-unassigned-users`、`GET /api/mcp/{id}/assigned-user-details`、`GET /api/mcp/{id}/assigned-user-names`
- SSE 事件结构：采用更丰富的 Json 多态（前端 `SseResponseKind` 与联合类型已匹配）

---

## 破坏性变更清单

- 大范围数据库结构调整与重命名，必须执行迁移 SQL
- `UserModelUsage/UsageTransaction` 不再引用 `UserModel`；删除 `UserModel.IsDeleted`
- `Chat.LeafMessageId` → `LeafTurnId`
- 删除多处默认值约束；如外部依赖默认值，请同步调整

---

## 已知提示

- 远端 MCP 工具枚举依赖对方服务，工具较多时首次抓取可能耗时
- 个别第三方模型的工具调用在边界情况下仍可能存在不兼容，请以服务商规范为准调整

---

## 致谢

- 感谢社区贡献者的支持！特别感谢 PR #96（by @xiehs211）带来的登录页面运行时错误修复。

---

如对本版本有任何问题或建议，欢迎在仓库提交 Issue 或 PR。祝使用愉快！
